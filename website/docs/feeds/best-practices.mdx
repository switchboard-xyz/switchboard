---
sidebar_position: 60
title: Best Practices
---

import FeedsBestPracticesOverview from "/data/docs/feeds_best_practices_overview.md";
import OracleConsensus from "/data/docs/oracle_consensus.md";
import JobsDiversity from "/data/docs/jobs_diversity.md";
import FeedsQueueSelection from "/data/docs/feeds_queue_selection.md";
import FeedsDataAvailability from "/data/docs/feeds_data_availability.md";
import FeedsOracleConsensus from "/data/docs/feeds_oracle_consensus.md";

<!-- TODO
- should split this content up into
- Data Availability
- Security
- Cost
- Advanced (TWAP)
- Integration Checklist
- Maintenance
- Maybe, Walkthrough
- add graphics
-->

<FeedsBestPracticesOverview />

## Oracle Consensus

<OracleConsensus />

## Democratizing Data Feeds

Switchboard is a decentralized protocol that allows users to publish and request
updates from a pool of oracles. Switchboard oracles allocate their resources to
updates requested from on-chain consumers. This leaves it up to the consumer to
decide what data is brought on-chain.

Switchboard feeds are public meaning anyone is free to read the value on-chain
so sometimes it is ideal to piggy back on an existing feed. This works well for
some protocols but leaves you vulnerable to sudden changes in your on-chain data
flow. This is a risk vector that can be mitigated by owning your own data feed
and being your feedâ€™s authority.

If youâ€™re using a public data feed, consider contributing to the feeds lease to
extend its lifetime.

ðŸ’¡ NOTE: The feed authority differs from the lease authority. Only the lease
authority is permitted to withdraw funds. When contributing to public leases
check the lease authority is set to an empty public key or else the feed
authority could withdraw the funds for themselves.

## Own Your Data

The feed authority has the power to modify the feed, including:

- change the job definitions and adapt to market conditions such as if a new
  exchange siphoned volume from the current sources
- speed up or slow down the feed depending on changing use cases
- change the reporting parameters to save on cost
- move the feed to a new queue for increased security or reliability
- complete ownership over your on-chain data flow

## DAO

A feed authority could even be set to a DAO where the quorum votes on changes to
a feeds configuration. This is true decentralization at play where the settings
of a feed are optimized for a variety of use cases where voting power could be
controlled by lease contributions or tokens staked.

## Tuning a Switchboard Feed

Now that we have some background on how switchboard oracles publish data
on-chain, letâ€™s look at how to configure a Switchboard feed.

### Data Source Diversity

<JobsDiversity />

### Queue Selection

<FeedsQueueSelection />

### Data Availability

<FeedsDataAvailability />

ðŸ’¡ NOTE: See the check_staleness function in the rust crate when integrating.

### Oracle Consensus

<FeedsOracleConsensus />

### Cost

The two main methods to reduce a feeds cost is to:

- increase the minUpdateDelay so updates are requested less often
- add a varianceTolerance so changes are only reported when a given percentage
  change threshold is reached. This will greatly reduce the number of updates
  on-chain during periods of low volatility so if you are using a staleness
  check in your on-chain program, make sure to pair it with forceReportPeriod so
  a value is always reported after a given staleness interval.

  Another way to reduce cost is to set the feed authority to a DAO and share the
  feed cost with other on-chain consumers. A DAO can be used to vote on feed
  changes and can help democratize data on-chain. If youâ€™re using a public data
  feed, consider contributing to the feeds lease to extend its lifetime.

### Redundancy

While Switchboard feeds have a proven track record, no system is fault tolerant
without some level of redundancy. If possible, you should pair a Switchboard
feed with another oracle provider or a TWAP feed to ensure you are viewing
reliable data. Stay tuned for a future article on advanced data feed usages.

## Recommended Feed Configuration

The following table highlights some recommended settings. This will not
encompass all use cases â€” use at your own discretion. Find us on Discord to
answer any configuration questions.

## Feed Maintenance

The following highlights some basic maintenance you should employ when working
with a Switchboard feed.

- **Monitor Lease Funds** â€” you should monitor your feeds lease account for low
  balances. When a feedâ€™s lease is emptied, it will no longer process new
  updates until it has enough to reward the oracles processing the update. We
  are working with a few web3 messaging services to enable wallet notifications
  when leases are low on funds.

- **Monitor Crank Eviction** â€” if a lease is emptied, it will also be evicted
  from its crank. Switchboard feeds act like public utilities where anyone is
  free to re-push it to a crank, as long as it doesnâ€™t have disableCrank set to
  true.
- **Monitor Data Sources** â€” Sometimes APIs change or move. High availability
  feeds should have some basic routine health checks to ensure their on-chain
  data is updating as expected.

## Integration Checklist

The switchboard-v2 crate is used to integrate Switchboard into your on-chain
programs. You can also view some example programs in the switchboard-v2 repo.

- Check aggregator is owned by the Switchboard program

- Check the latest round has more oracle responses than the minOracleResults
  (get_result)

- Optional, check the feed has not exceeded a given confidence interval
  (check_confidence_interval)

- Optional, check the feed has been updated recently (check_staleness)

## TWAPs and Historical Data

Switchboard feed owners can elect to add a history buffer to their feed. This
will automatically store the last N accepted results on-chain, where N is
configurable by the user from 1 to 350,000 samples, with the current Solana
account size limits. On-chain consumers can also read from the history buffer
and validate a subset of the history to ensure the current oracle price has not
skewed too far from the recent samples.

Once a feed has a history buffer, anyone can create a separate TWAP feed that
reads the history buffer and calculates the time weighted average. This is
useful for feeds that may have low liquidity and suffer from frequent price
swings.

More advanced usages of TWAP include the ability to source the TWAP price at
settlement each week. Let us say weâ€™re an options protocol with contracts
settling at 5PM UTC every Friday and we need a way to source the 1hr TWAP
leading up to settlement. We also need to ensure that value is always calculated
for that 1hr window so our liquidators are using the most accurate price
observed on-chain. With Switchboard, you can build a feed that will always
resolve to that 1hr window each week. You can see it in action here on devnet.
https://switchboard.xyz/explorer/2/9wChHmbtuLbjGYt9tdH7guLY9zaqT56veSxTba18k5N3

Switchboard data feeds aim to be as general as possible to meet all use cases.
If you require a more complicated data feed, do not hesitate to reach out
because we may be able to build a custom solution that will benefit not only you
but other data feed users.

## Feed Creation Walkthrough

Iâ€™m a brand new lending protocol and I need a new data feed for XYZ. Letâ€™s walk
through some considerations I might have for how to publish this feed.

### Queue Selection

This protocol will obviously be successful and have a significant total value
locked (TVL) so I should choose a secure queue. I look at a queue that already
has an XYZ feed but I notice the queue isnâ€™t as secure as I need; maybe it has a
low minimum stake requirement for oracles or doesnâ€™t slash oracles for
misreporting. So I check the Switchboard DAO and find a queue that requires
oracles to stake 10 SOL, has slashing enabled, requires feeds to be permitted to
join, and has a proven track record of honest reporting â€¦ perfect, we found the
queue weâ€™ll create the feed for.

ðŸ’¡ NOTE: Data feed owners can always move their feed to a new queue after
creation.

### Data Source Diversity

Next, weâ€™ll need to find where to source the data. I see 4 centralized exchanges
and 2 decentralized exchanges. Upon further inspection, I notice one of the CEXs
has questionable volume and one of the DEXs has no volume â€” so we should ignore
these sources. So weâ€™ll create the feed with 3 CEXs and 1 DEX. This is good but
letâ€™s see if we can do better. We see theres a Saber pool for this asset so we
can use the lpExchangeRateTask to fetch the price. We can also use the
jupiterSwapTask to aggregate through various on-chain sources and get us the
best price. Awesome, we have 3 CEXs, 1 DEX, a Saber pool source, and a Jupiter
Swap source.

We want the feed result to be calculated with enough sources so we have an
accurate depiction of the price but if we keep it too strict, a single source
failing could halt the feed â€” maybe one of the CEX sources had a data center
outage. Your minJobResults should be at least one less than the total number of
sources to account for this. To give us enough margin, weâ€™ll set ours to 4, so 4
out of 6 sources have to respond in order for the oracle to publish a price
update.

We notice the majority of the volume for this source is on a single CEX where
the majority of price discovery occurs â€” we should definitely weigh this source
higher than the rest. Hereâ€™s what that may look like.

### Data Availability

A lending protocol may not need the most up-to-date prices as compared to a
trading platform. So we will set the minUpdateDelaySeconds to 15. This should be
fast enough for our lending platform â€” we can always adjust if needed.

Weâ€™re a lending protocol on-chain so we need the data to be readily available â€”
so we will choose to push the feed onto a crank to enable automatic updates. The
crank is an incentivisation mechanism to regularly schedule feed updates. A
sport betting platform may opt-out of a crank since they will only need the data
when an event is settled.

### Oracle Consensus

Weâ€™re planning on securing financial capital with our data feeds so we need to
ensure a malicious oracle cannot skew the price feed in its favor. To do this we
will set the oracleRequestBatchSize to at least 8. This means 5+ oracles would
have to collude in order to skew a feeds accepted value on-chain; remember weâ€™re
using the median and not the average as the final result. Weâ€™ll then set
minOracleResults to 7 to account for any oracle networking issues that may
prevent them from responding. If only 7 oracles respond, at least 4 will need to
be acting in good faith to produce an honest result â€” which is a very reasonable
assumption to make since we selected our queue carefully.

### Cost

Woohoo, weâ€™re almost done. Weâ€™ve built the job definitions, configured and tuned
the settings, so we head over to the Switchboard publisher to build the feed. We
get to checkout and notice the cost may be a bit high for a lending protocol
that is just starting out. No worries, letâ€™s look at some ways to conserve cost.

Letâ€™s look at minUpdateDelaySeconds. Updating this feed every 15 seconds may be
a bit overkill. We can increase this to 30 to double the length of the feed.

The XYZ feed is a relatively low volatility feed, meaning the prices updated
on-chain may be the same or about the same each update round. To account for
this we can set the varianceThreshold to 0.1%, which instructs the oracles to
skip reporting a value if the value hasnâ€™t differed by 0.1% since the last
reported value on-chain. This will greatly extend the life of your feed but
makes it hard to estimate the length of time left on the feed since it will
depend on the feeds volatility and market conditions. Our feed will now only
incur a cost when a feeds value has changed significantly.

Great, weâ€™ve found some ways to reduce cost without sacrificing security. But
what if the XYZ asset suffers some loss of interest and reduce volatility? Your
feed may fail to update for hours on end if the price hasnâ€™t moved by the set
varianceThreshold. This can be mitigated by setting a forceReportPeriod, which
instructs the oracles to always report a result on-chain even if the variance
threshold wasnâ€™t exceeded, or max staleness. We will set forceReportPeriod to
900 so the feed will always report a value on-chain every 15minutes. When
integrating on-chain, we should always be checking if the feed was updated
within the forceReportPeriod interval to ensure the feed is healthy.
