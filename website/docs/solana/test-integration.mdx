---
sidebar_position: 5
title: Test Integration
---

import Tabs from "@theme/Tabs";
import TabItem from "@theme/TabItem";

Switchboard provides some tools to streamline test integration. **This requires
Docker to be installed and running on the host machine.**

:::tip

This is compatible with **localnet** and **devnet**.

:::

## Setup Localnet Environment

You may wish to run a localnet version of Switchboard to watch how your program
reacts to data feed updates. You will need to copy some Switchboard accounts
from devnet to your local validator on the initial startup sequence. This can be
done with Anchor by editing your Anchor.toml config or by starting the local
validator with the accounts provided.

See [Mainnet](/solana/program/mainnet) to get the list of respective mainnet
accounts to copy.

<Tabs>
  <TabItem value="Anchor" label="Anchor" default>

```toml
[test.validator]
url = "https://api.devnet.solana.com"

[test]
startup_wait = 15000

[[test.validator.clone]] # sbv2 devnet programID
address = "2TfB33aLaneQb5TNVwyDz3jSZXS6jdW2ARw1Dgf84XCG"

[[test.validator.clone]] # sbv2 devnet IDL
address = "CKwZcshn4XDvhaWVH9EXnk3iu19t6t5xP2Sy2pD6TRDp"

[[test.validator.clone]] # sbv2 devnet SbState
address = "BYM81n8HvTJuqZU1PmTVcwZ9G8uoji7FKM6EaPkwphPt"

[[test.validator.clone]] # sbv2 devnet tokenVault
address = "FVLfR6C2ckZhbSwBzZY4CX7YBcddUSge5BNeGQv5eKhy"

[[test.validator.clone]] # sbv2 SOL/USD Feed
address="GvDMxPzN1sCj7L26YDK2HnMRXEQmQ2aemov8YBtPS7vR"
```

:::note

Now start your tests with `anchor test --skip-local-validator`

:::

  </TabItem>
  <TabItem value="CLI" label="solana-test-validator CLI">

```bash
solana-test-validator -r --bind-address 0.0.0.0 --rpc-port 8899 \
  --url https://api.devnet.solana.com \
  --clone 2TfB33aLaneQb5TNVwyDz3jSZXS6jdW2ARw1Dgf84XCG `# programId` \
  --clone J4CArpsbrZqu1axqQ4AnrqREs3jwoyA1M5LMiQQmAzB9 `# programDataAddress` \
  --clone CKwZcshn4XDvhaWVH9EXnk3iu19t6t5xP2Sy2pD6TRDp `# idlAddress` \
  --clone BYM81n8HvTJuqZU1PmTVcwZ9G8uoji7FKM6EaPkwphPt `# programState` \
  --clone FVLfR6C2ckZhbSwBzZY4CX7YBcddUSge5BNeGQv5eKhy `# switchboardVault`
```

  </TabItem>
</Tabs>

## Test Suite

Update your test file and add a before and after hook to create your Switchboard
environment. You may omit the keypair arguements to create a brand new queue and
oracle with each run. If no keypair is found at the path provided, one will be
created for you.

The start method lets you specify the version of the oracle to run along with a
docker config.

```typescript
import {
  AggregatorAccount,
  SwitchboardTestContextV2,
} from "@switchboard-xyz/solana.js";

describe("anchor-feed-parser test", () => {
  const provider = anchor.AnchorProvider.env();
  anchor.setProvider(provider);

  let switchboard: SwitchboardTestContextV2;
  let aggregatorAccount: AggregatorAccount;

  before(async () => {
    switchboard = await SwitchboardTestContextV2.loadFromProvider(provider, {
      // You can provide a keypair to so the PDA schemes dont change between test runs
      name: "Test Queue",
      keypair: SwitchboardTestContextV2.loadKeypair("~/.keypairs/queue.json"),
      queueSize: 10,
      reward: 0,
      minStake: 0,
      oracleTimeout: 900,
      unpermissionedFeeds: true,
      unpermissionedVrf: true,
      enableBufferRelayers: true,
      oracle: {
        name: "Test Oracle",
        enable: true,
        stakingWalletKeypair: SwitchboardTestContextV2.loadKeypair(
          "~/.keypairs/oracleWallet.json"
        ),
      },
    });
    await switchboard.start();
  });

  after(async () => {
    if (switchboard) {
      switchboard.stop();
    }
  });

  it("Creates a static feed that resolves to 100", async () => {
    [aggregatorAccount] = await switchboard.queue.createFeed({
      batchSize: 1,
      minRequiredOracleResults: 1,
      minRequiredJobResults: 1,
      minUpdateDelaySeconds: 10,
      fundAmount: 0.15,
      enable: true,
      slidingWindow: true,
      jobs: [
        {
          data: OracleJob.encodeDelimited(
            OracleJob.fromObject({
              tasks: [
                {
                  valueTask: {
                    value: 100,
                  },
                },
              ],
            })
          ).finish(),
        },
      ],
    });

    const aggregator = await aggregatorAccount.loadData();
    const [updatedState] = await aggregatorAccount.openRoundAndAwaitResult();
    const result = AggregatorAccount.decodeLatestValue(updatedState);
    assert(result.toNumber() === 100, "Aggregator result mismatch");
  });
});
```
